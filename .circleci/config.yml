version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: Set up SSH access
          command: |
            mkdir -p ~/.ssh
            echo "$GCP_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan $GCP_VM_IP >> ~/.ssh/known_hosts

      - run:
          name: Copy App Files to GCP VM
          command: |
            ssh $GCP_VM_USER@$GCP_VM_IP "mkdir -p ~/flask-app"
            scp -r * $GCP_VM_USER@$GCP_VM_IP:~/flask-app

      - run:
          name: Build and Run Docker Container on VM
          command: |
            ssh $GCP_VM_USER@$GCP_VM_IP bash -c "'
              cd ~/flask-app
              docker stop flask-app || true
              docker rm flask-app || true
              docker build -t flask-app .
              docker run -d --name flask-app -p 80:80 flask-app
            '"

workflows:
  version: 2
  deploy-workflow:
    jobs:
      - deploy
